FROM ghcr.io/apollographql/router:v1.43.0

# Copy configuration
COPY config/router.yaml /dist/config/router.yaml

# Copy Rhai plugins
COPY plugins/ /app/plugins/

# Copy supergraph schema (generated by schema composition)
COPY supergraph.graphql /dist/supergraph.graphql

# Environment variables
ENV APOLLO_ROUTER_SUPERGRAPH_PATH=/dist/supergraph.graphql
ENV APOLLO_ROUTER_CONFIG_PATH=/dist/config/router.yaml
ENV APOLLO_ROUTER_LOG=info

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:8088/health || exit 1

# Expose ports
EXPOSE 4000
EXPOSE 8088
EXPOSE 9090

# Run router
ENTRYPOINT ["/dist/router"]
