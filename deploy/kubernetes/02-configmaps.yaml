# =============================================================================
# CONFIGMAPS - Yousoon Platform
# =============================================================================

---
# Configuration globale Yousoon
apiVersion: v1
kind: ConfigMap
metadata:
  name: yousoon-config
  namespace: yousoon
  labels:
    app.kubernetes.io/component: configuration
data:
  # Environment
  environment: "development"
  log-level: "info"
  
  # Service URLs (internal)
  identity-service-url: "http://identity-service.yousoon.svc.cluster.local"
  partner-service-url: "http://partner-service.yousoon.svc.cluster.local"
  discovery-service-url: "http://discovery-service.yousoon.svc.cluster.local"
  booking-service-url: "http://booking-service.yousoon.svc.cluster.local"
  engagement-service-url: "http://engagement-service.yousoon.svc.cluster.local"
  notification-service-url: "http://notification-service.yousoon.svc.cluster.local"
  
  # Redis URL
  redis-url: "redis://redis:6379"
  
  # Elasticsearch
  elasticsearch-url: "http://elasticsearch:9200"
  elasticsearch-index-prefix: "yousoon"
  
  # NATS
  nats-url: "nats://nats:4222"
  
  # S3 Configuration
  s3-bucket: "yousoon-media"
  s3-region: "eu-west-1"
  cloudfront-url: "https://cdn.yousoon.com"
  
  # Feature flags
  enable-playground: "false"
  enable-introspection: "false"
  
  # Observability
  otel-endpoint: "http://jaeger-collector.yousoon.svc.cluster.local:4317"
  metrics-enabled: "true"
  tracing-enabled: "true"

---
# Apollo Router Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: router-config
  namespace: yousoon
  labels:
    app.kubernetes.io/component: gateway
data:
  router.yaml: |
    # Apollo Router Configuration
    supergraph:
      listen: 0.0.0.0:4000
      introspection: false
      
    health_check:
      listen: 0.0.0.0:8088
      
    sandbox:
      enabled: false
      
    homepage:
      enabled: false
      
    # Subgraphs configuration
    override_subgraph_url:
      identity: http://identity-service.yousoon.svc.cluster.local
      partner: http://partner-service.yousoon.svc.cluster.local
      discovery: http://discovery-service.yousoon.svc.cluster.local
      booking: http://booking-service.yousoon.svc.cluster.local
      engagement: http://engagement-service.yousoon.svc.cluster.local
      notification: http://notification-service.yousoon.svc.cluster.local
      
    # Authentication
    authentication:
      router:
        jwt:
          jwks:
            - url: http://identity-service.yousoon.svc.cluster.local/.well-known/jwks.json
              
    # Rate limiting
    traffic_shaping:
      all:
        global_rate_limit:
          capacity: 1000
          interval: 1s
        timeout: 30s
        
    # CORS
    cors:
      allow_any_origin: false
      origins:
        - https://yousoon.com
        - https://www.yousoon.com
        - https://business.yousoon.com
        - https://admin.yousoon.com
        # Dev origins
        - http://localhost:3000
        - http://localhost:5173
      
    # Telemetry
    telemetry:
      exporters:
        tracing:
          otlp:
            enabled: true
            endpoint: http://jaeger-collector.yousoon.svc.cluster.local:4317
        metrics:
          prometheus:
            enabled: true
            listen: 0.0.0.0:9090
            path: /metrics
            
    # Limits
    limits:
      max_depth: 15
      max_height: 200
      max_aliases: 30

---
# Router Plugins
apiVersion: v1
kind: ConfigMap
metadata:
  name: router-plugins
  namespace: yousoon
  labels:
    app.kubernetes.io/component: gateway
data:
  auth.rhai: |
    // Authentication plugin for Apollo Router
    fn supergraph_service(service) {
      let request_callback = |request| {
        // Get Authorization header
        let auth_header = request.headers["authorization"];
        
        if auth_header != () {
          // Extract token and add to context
          let parts = auth_header.split(" ");
          if parts.len() == 2 && parts[0] == "Bearer" {
            request.context["jwt_token"] = parts[1];
          }
        }
        
        request
      };
      
      service.map_request(request_callback)
    }
    
  logging.rhai: |
    // Logging plugin
    fn supergraph_service(service) {
      let request_callback = |request| {
        log_info(`GraphQL request: ${request.body.query}`);
        request
      };
      
      service.map_request(request_callback)
    }
