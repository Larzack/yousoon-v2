{{/*
# =============================================================================
# Yousoon Monitoring - Services
# =============================================================================
*/}}

{{- if ne .Values.global.infra "disabled" }}

{{- if eq .Values.global.infra "sidecar" }}
# =============================================================================
# SIDECAR MODE: Single Service with multiple ports
# =============================================================================
apiVersion: v1
kind: Service
metadata:
  name: {{ include "yousoon-monitoring.fullname" . }}
  labels:
    {{- include "yousoon-monitoring.labels" . | nindent 4 }}
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    {{- if .Values.prometheus.enabled }}
    - name: prometheus
      port: {{ .Values.prometheus.port }}
      targetPort: prometheus
      protocol: TCP
    {{- end }}
    {{- if .Values.grafana.enabled }}
    - name: grafana
      port: {{ .Values.grafana.port }}
      targetPort: grafana
      protocol: TCP
    {{- end }}
    {{- if .Values.loki.enabled }}
    - name: loki
      port: {{ .Values.loki.port }}
      targetPort: loki
      protocol: TCP
    {{- end }}
    {{- if .Values.jaeger.enabled }}
    - name: jaeger-query
      port: {{ .Values.jaeger.ports.query }}
      targetPort: jaeger-query
      protocol: TCP
    - name: jaeger-collect
      port: {{ .Values.jaeger.ports.collector }}
      targetPort: jaeger-collect
      protocol: TCP
    - name: jaeger-agent
      port: {{ .Values.jaeger.ports.agent }}
      targetPort: jaeger-agent
      protocol: UDP
    {{- end }}
  selector:
    {{- include "yousoon-monitoring.selectorLabels" . | nindent 4 }}

{{- else }}
# =============================================================================
# CLASSIC MODE: Separate Service for each component
# =============================================================================

{{- if .Values.prometheus.enabled }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "yousoon-monitoring.fullname" . }}-prometheus
  labels:
    {{- include "yousoon-monitoring.labels" . | nindent 4 }}
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - name: http
      port: {{ .Values.prometheus.port }}
      targetPort: http
      protocol: TCP
  selector:
    app.kubernetes.io/name: prometheus
    app.kubernetes.io/instance: {{ .Release.Name }}
{{- end }}

{{- if .Values.grafana.enabled }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "yousoon-monitoring.fullname" . }}-grafana
  labels:
    {{- include "yousoon-monitoring.labels" . | nindent 4 }}
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - name: http
      port: {{ .Values.grafana.port }}
      targetPort: http
      protocol: TCP
  selector:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/instance: {{ .Release.Name }}
{{- end }}

{{- if .Values.loki.enabled }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "yousoon-monitoring.fullname" . }}-loki
  labels:
    {{- include "yousoon-monitoring.labels" . | nindent 4 }}
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - name: http
      port: {{ .Values.loki.port }}
      targetPort: http
      protocol: TCP
  selector:
    app.kubernetes.io/name: loki
    app.kubernetes.io/instance: {{ .Release.Name }}
{{- end }}

{{- if .Values.jaeger.enabled }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "yousoon-monitoring.fullname" . }}-jaeger
  labels:
    {{- include "yousoon-monitoring.labels" . | nindent 4 }}
spec:
  type: ClusterIP
  ports:
    - name: query
      port: {{ .Values.jaeger.ports.query }}
      targetPort: query
      protocol: TCP
    - name: collector
      port: {{ .Values.jaeger.ports.collector }}
      targetPort: collector
      protocol: TCP
    - name: agent
      port: {{ .Values.jaeger.ports.agent }}
      targetPort: agent
      protocol: UDP
  selector:
    app.kubernetes.io/name: jaeger
    app.kubernetes.io/instance: {{ .Release.Name }}
{{- end }}

{{- end }}

{{- end }} {{/* end if ne .Values.global.infra "disabled" */}}
