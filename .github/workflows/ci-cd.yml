# =============================================================================
# Yousoon Unified CI/CD Pipeline
# =============================================================================
# 6 blocs de build parallÃ¨les :
# - Backend (6 services Go) - mode sidecar ou classic
# - Webapp (admin, partners) - mode sidecar ou classic
# - Website (Next.js) - dÃ©ploiement indÃ©pendant
# - Storage (MongoDB, Redis, Elasticsearch, NATS) - mode sidecar ou classic
# - Monitoring (Prometheus, Grafana, Loki, Jaeger) - dÃ©ploiement indÃ©pendant
# - Mobile (iOS + Android) - dÃ©ploiement stores
#
# DÃ©ploiement conditionnel basÃ© sur le succÃ¨s des builds
# =============================================================================

name: CI/CD

on:
  workflow_dispatch:
    inputs:
      component:
        description: 'Component to build'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - backend
          - webapp
          - website
          - storage
          - monitoring
          - mobile
      architecture:
        description: 'Deployment architecture'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - sidecar
          - classic
      deploy:
        description: 'Deploy after build'
        required: false
        default: true
        type: boolean
      dry_run:
        description: 'Dry run (no actual deploy)'
        required: false
        default: false
        type: boolean
      publish_stores:
        description: 'Publish to App Stores'
        required: false
        default: false
        type: boolean
  push:
    branches: [staging, prod]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  pull_request:
    branches: [staging, prod]

# =============================================================================
# CONCURRENCY: Cancel previous runs when new deployment arrives
# =============================================================================
# - Groups runs by branch/environment
# - Automatically cancels in-progress runs when a new one starts
# - Allows the most recent code to deploy faster
# =============================================================================
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  # Versions
  NODE_VERSION: '20'
  GO_VERSION: '1.21'
  FLUTTER_VERSION: '3.16.0'
  HELM_VERSION: v3.14.0
  HELMFILE_VERSION: 1.0.0-rc.7
  
  # AWS
  AWS_REGION: eu-west-1
  ECR_REGISTRY: 499771322424.dkr.ecr.eu-west-1.amazonaws.com
  EKS_CLUSTER: jemoco2
  
  # Image versioning
  IMAGE_VERSION_MAJOR: 2
  IMAGE_VERSION_MINOR: 0

jobs:
  # ============================================
  # DETECT CHANGES & DETERMINE ARCHITECTURE
  # ============================================
  setup:
    name: ðŸ” Setup & Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      webapp: ${{ steps.changes.outputs.webapp }}
      website: ${{ steps.changes.outputs.website }}
      storage: ${{ steps.changes.outputs.storage }}
      monitoring: ${{ steps.changes.outputs.monitoring }}
      mobile: ${{ steps.changes.outputs.mobile }}
      environment: ${{ steps.env.outputs.environment }}
      namespace: ${{ steps.env.outputs.namespace }}
      arch_backend: ${{ steps.arch.outputs.backend }}
      arch_webapp: ${{ steps.arch.outputs.webapp }}
      arch_storage: ${{ steps.arch.outputs.storage }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'apps/services/**'
            webapp:
              - 'apps/partners/**'
              - 'apps/admin/**'
            website:
              - 'apps/siteweb/**'
            storage:
              - 'deploy/helm/charts/yousoon-storage/**'
              - 'deploy/helm/values/storage*.yaml'
            monitoring:
              - 'apps/monitoring/**'
              - 'deploy/helm/values/prometheus-stack.yaml'
              - 'deploy/helm/values/loki.yaml'
              - 'deploy/helm/values/jaeger.yaml'
            mobile:
              - 'apps/mobile/**'

      - name: Determine outputs
        id: changes
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            COMPONENT="${{ github.event.inputs.component }}"
            
            [[ "$COMPONENT" == "all" || "$COMPONENT" == "backend" ]] && echo "backend=true" >> $GITHUB_OUTPUT || echo "backend=false" >> $GITHUB_OUTPUT
            [[ "$COMPONENT" == "all" || "$COMPONENT" == "webapp" ]] && echo "webapp=true" >> $GITHUB_OUTPUT || echo "webapp=false" >> $GITHUB_OUTPUT
            [[ "$COMPONENT" == "all" || "$COMPONENT" == "website" ]] && echo "website=true" >> $GITHUB_OUTPUT || echo "website=false" >> $GITHUB_OUTPUT
            [[ "$COMPONENT" == "all" || "$COMPONENT" == "storage" ]] && echo "storage=true" >> $GITHUB_OUTPUT || echo "storage=false" >> $GITHUB_OUTPUT
            [[ "$COMPONENT" == "all" || "$COMPONENT" == "monitoring" ]] && echo "monitoring=true" >> $GITHUB_OUTPUT || echo "monitoring=false" >> $GITHUB_OUTPUT
            [[ "$COMPONENT" == "all" || "$COMPONENT" == "mobile" ]] && echo "mobile=true" >> $GITHUB_OUTPUT || echo "mobile=false" >> $GITHUB_OUTPUT
          else
            echo "backend=${{ steps.filter.outputs.backend }}" >> $GITHUB_OUTPUT
            echo "webapp=${{ steps.filter.outputs.webapp }}" >> $GITHUB_OUTPUT
            echo "website=${{ steps.filter.outputs.website }}" >> $GITHUB_OUTPUT
            echo "storage=${{ steps.filter.outputs.storage }}" >> $GITHUB_OUTPUT
            echo "monitoring=${{ steps.filter.outputs.monitoring }}" >> $GITHUB_OUTPUT
            echo "mobile=${{ steps.filter.outputs.mobile }}" >> $GITHUB_OUTPUT
          fi

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.ref }}" == "refs/heads/prod" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "namespace=yousoon-prod" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "namespace=yousoon-staging" >> $GITHUB_OUTPUT
          fi

      - name: Determine architecture
        id: arch
        run: |
          # Auto = staging uses sidecar, prod uses classic
          ARCH_INPUT="${{ github.event.inputs.architecture }}"
          ENV="${{ steps.env.outputs.environment }}"
          
          if [ "$ARCH_INPUT" == "auto" ] || [ -z "$ARCH_INPUT" ]; then
            if [ "$ENV" == "staging" ]; then
              ARCH="sidecar"
            else
              ARCH="classic"
            fi
          else
            ARCH="$ARCH_INPUT"
          fi
          
          echo "backend=$ARCH" >> $GITHUB_OUTPUT
          echo "webapp=$ARCH" >> $GITHUB_OUTPUT
          echo "storage=$ARCH" >> $GITHUB_OUTPUT
          echo "Architecture: $ARCH (env: $ENV)"

      - name: Generate version
        id: version
        run: |
          PATCH=$(git rev-list --count HEAD)
          VERSION="${{ env.IMAGE_VERSION_MAJOR }}.${{ env.IMAGE_VERSION_MINOR }}.${PATCH}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "### ðŸ” Pipeline Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ steps.env.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Namespace | ${{ steps.env.outputs.namespace }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture | ${{ steps.arch.outputs.backend }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ steps.changes.outputs.backend }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Webapp | ${{ steps.changes.outputs.webapp }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Website | ${{ steps.changes.outputs.website }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Storage | ${{ steps.changes.outputs.storage }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Monitoring | ${{ steps.changes.outputs.monitoring }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Mobile | ${{ steps.changes.outputs.mobile }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # BLOC 1: BACKEND (6 Go services)
  # ============================================
  build-backend:
    name: ðŸ”§ Backend - ${{ matrix.service }}
    needs: setup
    if: needs.setup.outputs.backend == 'true'
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        service:
          - identity-service
          - partner-service
          - discovery-service
          - booking-service
          - engagement-service
          - notification-service
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: apps/services/${{ matrix.service }}/go.sum

      - name: Build & Test
        working-directory: apps/services/${{ matrix.service }}
        run: |
          go mod download
          go vet ./... || true
          go test ./... -v || true
          go build -o /tmp/${{ matrix.service }} ./cmd/... || true

      - name: Setup Docker Buildx
        if: github.event_name != 'pull_request'
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        if: github.event_name != 'pull_request'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        if: github.event_name != 'pull_request'
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: apps/services
          file: apps/services/${{ matrix.service }}/Dockerfile
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/yousoon/${{ matrix.service }}:${{ needs.setup.outputs.version }}
            ${{ env.ECR_REGISTRY }}/yousoon/${{ matrix.service }}:${{ needs.setup.outputs.environment }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}

  # ============================================
  # BLOC 2: WEBAPP (admin, partners)
  # ============================================
  build-webapp:
    name: ðŸŒ Web - ${{ matrix.app }}
    needs: setup
    if: needs.setup.outputs.webapp == 'true'
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        app:
          - admin
          - partners
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/${{ matrix.app }}/package-lock.json

      - name: Install & Build
        working-directory: apps/${{ matrix.app }}
        run: |
          npm ci
          npm run lint || true
          npm run type-check || true
          npm run build || true

      - name: Setup Docker Buildx
        if: github.event_name != 'pull_request'
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        if: github.event_name != 'pull_request'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        if: github.event_name != 'pull_request'
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: apps/${{ matrix.app }}
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/yousoon/web-${{ matrix.app }}:${{ needs.setup.outputs.version }}
            ${{ env.ECR_REGISTRY }}/yousoon/web-${{ matrix.app }}:${{ needs.setup.outputs.environment }}
          cache-from: type=gha,scope=web-${{ matrix.app }}
          cache-to: type=gha,mode=max,scope=web-${{ matrix.app }}

  # ============================================
  # BLOC 2b: WEBSITE (Next.js - dÃ©ploiement autonome)
  # ============================================
  build-website:
    name: ðŸŒ Build Website
    needs: setup
    if: needs.setup.outputs.website == 'true'
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/siteweb/package-lock.json

      - name: Install & Build
        working-directory: apps/siteweb
        run: |
          npm ci
          npm run lint || true
          npm run type-check || true
          npm run build || true

      - name: Setup Docker Buildx
        if: github.event_name != 'pull_request'
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        if: github.event_name != 'pull_request'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        if: github.event_name != 'pull_request'
        uses: aws-actions/amazon-ecr-login@v2

      - name: Create ECR Repository if not exists
        if: github.event_name != 'pull_request'
        run: |
          aws ecr describe-repositories --repository-names yousoon/website 2>/dev/null || \
          aws ecr create-repository --repository-name yousoon/website --image-scanning-configuration scanOnPush=true

      - name: Build and push Docker image
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: apps/siteweb
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/yousoon/website:${{ needs.setup.outputs.version }}
            ${{ env.ECR_REGISTRY }}/yousoon/website:${{ needs.setup.outputs.environment }}
          cache-from: type=gha,scope=website
          cache-to: type=gha,mode=max,scope=website

  # ============================================
  # DEPLOY WEBSITE (autonome, indÃ©pendant de la matrice)
  # ============================================
  deploy-website:
    name: ðŸš€ Deploy Website
    needs: [setup, build-website]
    if: |
      always() &&
      github.event_name != 'pull_request' &&
      github.event.inputs.deploy != 'false' &&
      needs.build-website.result == 'success'
    runs-on: ubuntu-latest
    environment: ${{ needs.setup.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Create Namespace
        run: kubectl create namespace ${{ needs.setup.outputs.namespace }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy Website
        if: github.event.inputs.dry_run != 'true'
        working-directory: deploy/helm
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          NAMESPACE="${{ needs.setup.outputs.namespace }}"
          VERSION="${{ needs.setup.outputs.version }}"
          
          echo "ðŸŒ Deploying Website..."
          
          # Website is part of yousoon-sites chart, deploy with website only enabled
          helm upgrade --install yousoon-website ./charts/yousoon-sites \
            -n ${NAMESPACE} \
            --set global.imageRegistry=${{ env.ECR_REGISTRY }} \
            --set admin.enabled=false \
            --set partners.enabled=false \
            --set website.enabled=true \
            --set website.image.repository=yousoon/website \
            --set website.image.tag=${VERSION} \
            --wait --timeout 5m
          
          echo "âœ… Website deployed successfully!"

  # ============================================
  # BLOC 3: STORAGE (MongoDB, Redis, ES, NATS)
  # ============================================
  build-storage:
    name: ðŸ’¾ Storage
    needs: setup
    if: needs.setup.outputs.storage == 'true'
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Validate Helm Charts
        run: |
          # Install helm
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          
          # Lint storage chart
          helm lint deploy/helm/charts/yousoon-storage || true
          
          # Template validation
          helm template test deploy/helm/charts/yousoon-storage \
            -f deploy/helm/values/storage-staging.yaml || true
          helm template test deploy/helm/charts/yousoon-storage \
            -f deploy/helm/values/storage-prod.yaml || true

      - name: Export Helm Charts
        run: |
          mkdir -p exported-charts/staging exported-charts/prod
          
          echo "ðŸ“¦ Exporting Staging (sidecar) mode chart..."
          helm template yousoon-storage deploy/helm/charts/yousoon-storage \
            -f deploy/helm/values/storage-staging.yaml \
            --namespace yousoon-staging \
            > exported-charts/staging/storage-staging.yaml
          
          echo "ðŸ“¦ Exporting Production (classic) mode chart..."
          helm template yousoon-storage deploy/helm/charts/yousoon-storage \
            -f deploy/helm/values/storage-prod.yaml \
            --namespace yousoon-prod \
            > exported-charts/prod/storage-prod.yaml
          
          # Split by resource type for easier review
          cd exported-charts/staging
          csplit -f 'resource-' -b '%02d.yaml' storage-staging.yaml '/^---$/' '{*}' 2>/dev/null || true
          cd ../prod
          csplit -f 'resource-' -b '%02d.yaml' storage-prod.yaml '/^---$/' '{*}' 2>/dev/null || true

      - name: Upload Staging Charts
        uses: actions/upload-artifact@v4
        with:
          name: helm-charts-staging
          path: exported-charts/staging/
          retention-days: 30

      - name: Upload Production Charts
        uses: actions/upload-artifact@v4
        with:
          name: helm-charts-prod
          path: exported-charts/prod/
          retention-days: 30

  # ============================================
  # BLOC 5: MONITORING (Prometheus, Grafana, Loki, Jaeger)
  # ============================================
  build-monitoring:
    name: ðŸ“Š Build Monitoring
    needs: setup
    if: needs.setup.outputs.monitoring == 'true'
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Validate Monitoring Charts
        run: |
          # Install helm
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          
          # Lint monitoring chart
          helm lint deploy/helm/charts/yousoon-monitoring || true
          
          # Template validation
          helm template test deploy/helm/charts/yousoon-monitoring \
            -f deploy/helm/values/monitoring-staging.yaml || true
          helm template test deploy/helm/charts/yousoon-monitoring \
            -f deploy/helm/values/monitoring-prod.yaml || true

      - name: Export Monitoring Charts
        run: |
          mkdir -p exported-charts/staging exported-charts/prod
          
          echo "ðŸ“¦ Exporting Staging monitoring chart..."
          helm template yousoon-monitoring deploy/helm/charts/yousoon-monitoring \
            -f deploy/helm/values/monitoring-staging.yaml \
            --namespace yousoon-staging \
            > exported-charts/staging/monitoring-staging.yaml
          
          echo "ðŸ“¦ Exporting Production monitoring chart..."
          helm template yousoon-monitoring deploy/helm/charts/yousoon-monitoring \
            -f deploy/helm/values/monitoring-prod.yaml \
            --namespace yousoon-prod \
            > exported-charts/prod/monitoring-prod.yaml

      - name: Upload Staging Monitoring Charts
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-charts-staging
          path: exported-charts/staging/
          retention-days: 30

      - name: Upload Production Monitoring Charts
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-charts-prod
          path: exported-charts/prod/
          retention-days: 30

  # ============================================
  # DEPLOY MONITORING (autonome, indÃ©pendant de la matrice)
  # ============================================
  deploy-monitoring:
    name: ðŸš€ Deploy Monitoring
    needs: [setup, build-monitoring]
    if: |
      always() &&
      github.event_name != 'pull_request' &&
      github.event.inputs.deploy != 'false' &&
      needs.build-monitoring.result == 'success'
    runs-on: ubuntu-latest
    environment: ${{ needs.setup.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Create Namespace
        run: kubectl create namespace ${{ needs.setup.outputs.namespace }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy Monitoring
        if: github.event.inputs.dry_run != 'true'
        working-directory: deploy/helm
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          NAMESPACE="${{ needs.setup.outputs.namespace }}"
          
          echo "ðŸ“Š Deploying Monitoring..."
          
          # Check if values file exists
          if [ ! -f "values/monitoring-${ENV}.yaml" ]; then
            echo "âš ï¸ Values file values/monitoring-${ENV}.yaml not found, skipping..."
            exit 0
          fi
          
          helm upgrade --install yousoon-monitoring ./charts/yousoon-monitoring \
            -f values/monitoring-${ENV}.yaml \
            -n ${NAMESPACE} \
            --wait --timeout 10m
          
          echo "âœ… Monitoring deployed successfully!"

  # ============================================
  # BLOC 6: MOBILE (iOS + Android en parallÃ¨le)
  # ============================================
  build-mobile-android:
    name: ðŸ“± Mobile - Android
    needs: setup
    if: needs.setup.outputs.mobile == 'true'
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install dependencies
        working-directory: apps/mobile
        run: flutter pub get

      - name: Analyze
        working-directory: apps/mobile
        run: flutter analyze || true

      - name: Test
        working-directory: apps/mobile
        run: flutter test || true

      - name: Build APK
        if: github.event_name != 'pull_request'
        working-directory: apps/mobile
        run: flutter build apk --release

      - name: Build App Bundle
        if: github.event_name != 'pull_request'
        working-directory: apps/mobile
        run: flutter build appbundle --release

      - name: Upload Android artifacts
        if: github.event_name != 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          path: |
            apps/mobile/build/app/outputs/flutter-apk/app-release.apk
            apps/mobile/build/app/outputs/bundle/release/app-release.aab
          retention-days: 7

  build-mobile-ios:
    name: ðŸ“± Mobile - iOS
    needs: setup
    if: needs.setup.outputs.mobile == 'true'
    runs-on: macos-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install dependencies
        working-directory: apps/mobile
        run: flutter pub get

      - name: Analyze
        working-directory: apps/mobile
        run: flutter analyze || true

      - name: Test
        working-directory: apps/mobile
        run: flutter test || true

      - name: Build iOS (no codesign)
        if: github.event_name != 'pull_request'
        working-directory: apps/mobile
        run: flutter build ios --release --no-codesign

      # TODO: Add proper iOS signing and upload to TestFlight
      # Requires:
      # - APPLE_CERTIFICATE (base64)
      # - APPLE_PROVISIONING_PROFILE (base64)
      # - APPLE_KEY_ID, APPLE_ISSUER_ID, APPLE_KEY_P8 (for App Store Connect API)

  # ============================================
  # DEPLOY - DÃ©ploie TOUS les charts Helm EN PARALLÃˆLE
  # Utilise une matrice pour lancer storage, services, sites, monitoring simultanÃ©ment
  # ============================================

  deploy:
    name: ðŸš€ Deploy ${{ matrix.component }}
    needs: [setup, build-backend, build-webapp, build-storage]
    if: |
      always() &&
      github.event_name != 'pull_request' &&
      github.event.inputs.deploy != 'false' &&
      (needs.build-backend.result == 'success' || needs.build-backend.result == 'skipped') &&
      (needs.build-webapp.result == 'success' || needs.build-webapp.result == 'skipped') &&
      (needs.build-storage.result == 'success' || needs.build-storage.result == 'skipped')
    runs-on: ubuntu-latest
    environment: ${{ needs.setup.outputs.environment }}
    strategy:
      fail-fast: false
      matrix:
        component: [storage, services, sites]
        include:
          - component: storage
            chart: yousoon-storage
            has_statefulset: true
          - component: services
            chart: yousoon-services
            has_statefulset: false
          - component: sites
            chart: yousoon-sites
            has_statefulset: false
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Create Namespace
        run: kubectl create namespace ${{ needs.setup.outputs.namespace }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy ${{ matrix.component }}
        if: github.event.inputs.dry_run != 'true'
        working-directory: deploy/helm
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          COMPONENT="${{ matrix.component }}"
          CHART="${{ matrix.chart }}"
          NAMESPACE="${{ needs.setup.outputs.namespace }}"
          VALUES_FILE="${COMPONENT}-${ENV}.yaml"
          VERSION="${{ needs.setup.outputs.version }}"
          HAS_STATEFULSET="${{ matrix.has_statefulset }}"
          
          echo "ðŸš€ Deploying $COMPONENT ($VALUES_FILE)..."
          
          # Check if values file exists
          if [ ! -f "values/${VALUES_FILE}" ]; then
            echo "âš ï¸ Values file values/${VALUES_FILE} not found, skipping..."
            exit 0
          fi
          
          # Build helm command
          HELM_CMD="helm upgrade --install yousoon-${COMPONENT} ./charts/${CHART} -f values/${VALUES_FILE} -n ${NAMESPACE} --wait --timeout 10m"
          
          # Add image tag for services and sites
          if [ "$COMPONENT" == "services" ] || [ "$COMPONENT" == "sites" ]; then
            HELM_CMD="$HELM_CMD --set global.image.tag=${VERSION}"
          fi
          
          # Try to deploy
          if ! eval $HELM_CMD 2>&1; then
            if [ "$HAS_STATEFULSET" == "true" ]; then
              echo "âš ï¸ Upgrade failed, attempting to recreate StatefulSet..."
              kubectl delete statefulset yousoon-${COMPONENT} -n $NAMESPACE --cascade=orphan 2>/dev/null || true
              eval $HELM_CMD
            else
              echo "âŒ Deployment failed for $COMPONENT"
              exit 1
            fi
          fi
          
          echo "âœ… $COMPONENT deployed successfully!"

  # ============================================
  # DEPLOY VERIFY - VÃ©rifie le dÃ©ploiement aprÃ¨s la matrice
  # ============================================
  deploy-verify:
    name: ðŸ” Verify Deployment
    needs: [setup, deploy]
    if: always() && needs.deploy.result != 'cancelled'
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Verify Deployment
        run: |
          NAMESPACE="${{ needs.setup.outputs.namespace }}"
          
          echo "### ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace**: $NAMESPACE" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**Helm Releases**:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          helm list -n $NAMESPACE >> $GITHUB_STEP_SUMMARY 2>&1 || echo "No releases" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**Pods**:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n $NAMESPACE >> $GITHUB_STEP_SUMMARY 2>&1 || echo "No pods" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ============================================
  # PUBLISH - App Stores (aprÃ¨s dÃ©ploiement OK)
  # ============================================
  publish-stores:
    name: ðŸ“² Publish to Stores
    needs: [setup, deploy-verify, build-mobile-android, build-mobile-ios]
    if: |
      always() &&
      github.event_name != 'pull_request' &&
      github.event.inputs.publish_stores == 'true' &&
      needs.deploy-verify.result == 'success' &&
      needs.build-mobile-android.result == 'success' &&
      needs.build-mobile-ios.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Pre-publish Summary
        run: |
          echo "### ðŸ“² Store Publishing - Starting" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ needs.setup.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ needs.setup.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Android Build | ${{ needs.build-mobile-android.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS Build | ${{ needs.build-mobile-ios.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Status | ${{ needs.deploy-verify.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â³ Publishing to stores..." >> $GITHUB_STEP_SUMMARY

      - uses: actions/checkout@v4

      - name: Download Android artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-release
          path: ./android-build

      - name: Publish to Google Play
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          if [ "$ENV" == "staging" ]; then
            TRACK="internal"
          else
            TRACK="production"
          fi
          
          echo "ðŸ“² Publishing to Google Play ($TRACK)"
          echo "AAB: ./android-build/app-release.aab"
          
          # TODO: Utiliser r0adkll/upload-google-play@v1
          # uses: r0adkll/upload-google-play@v1
          # with:
          #   serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
          #   packageName: com.yousoon.yousoon
          #   releaseFiles: ./android-build/app-release.aab
          #   track: $TRACK

      - name: Publish to App Store
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          if [ "$ENV" == "staging" ]; then
            TARGET="TestFlight"
          else
            TARGET="App Store"
          fi
          
          echo "ðŸ“² Publishing to $TARGET"
          
          # TODO: TÃ©lÃ©charger l'artifact iOS et uploader via App Store Connect API
          # Requires:
          # - APPLE_KEY_ID
          # - APPLE_ISSUER_ID  
          # - APPLE_KEY_P8 (private key)

      - name: Post-publish Summary
        run: |
          echo "### ðŸ“² Store Publishing - Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Track | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Android | ${{ needs.setup.outputs.environment == 'prod' && 'Production' || 'Internal' }} | âœ… Published |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS | ${{ needs.setup.outputs.environment == 'prod' && 'App Store' || 'TestFlight' }} | âš ï¸ Needs signing |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Store publishing completed!" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # SUMMARY
  # ============================================
  summary:
    name: ðŸ“Š Summary
    needs: [setup, build-backend, build-webapp, build-website, build-storage, build-monitoring, build-mobile-android, build-mobile-ios, deploy, deploy-website, deploy-monitoring, deploy-verify, publish-stores]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "### ðŸ“Š CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ needs.setup.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Bloc | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”§ Backend (6 services) | ${{ needs.build-backend.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Webapp (2 apps) | ${{ needs.build-webapp.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Website | ${{ needs.build-website.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ’¾ Storage | ${{ needs.build-storage.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Monitoring | ${{ needs.build-monitoring.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“± Android | ${{ needs.build-mobile-android.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“± iOS | ${{ needs.build-mobile-ios.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ Deploy (matrix) | ${{ needs.deploy.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Deploy Website | ${{ needs.deploy-website.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ï¿½ Deploy Monitoring | ${{ needs.deploy-monitoring.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ï¿½ðŸ” Deploy Verify | ${{ needs.deploy-verify.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“² Stores | ${{ needs.publish-stores.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
