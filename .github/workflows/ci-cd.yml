# =============================================================================
# Yousoon Unified CI/CD Pipeline
# =============================================================================
# 6 blocs de build parallÃ¨les :
# - Backend (6 services Go) - mode sidecar ou classic
# - Web (admin, partners) - mode sidecar ou classic
# - Siteweb (Next.js) - dÃ©ploiement indÃ©pendant
# - Storage (MongoDB, Redis, Elasticsearch, NATS) - mode sidecar ou classic
# - Monitoring (Prometheus, Grafana, Loki, Jaeger) - dÃ©ploiement indÃ©pendant
# - Mobile (iOS + Android) - dÃ©ploiement stores
#
# DÃ©ploiement conditionnel basÃ© sur le succÃ¨s des builds
# =============================================================================

name: CI/CD

on:
  workflow_dispatch:
    inputs:
      component:
        description: 'Component to build'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - backend
          - web
          - siteweb
          - storage
          - monitoring
          - mobile
      architecture:
        description: 'Deployment architecture'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - sidecar
          - classic
      deploy:
        description: 'Deploy after build'
        required: false
        default: true
        type: boolean
      dry_run:
        description: 'Dry run (no actual deploy)'
        required: false
        default: false
        type: boolean
      publish_stores:
        description: 'Publish to App Stores'
        required: false
        default: false
        type: boolean
  push:
    branches: [staging, prod]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  pull_request:
    branches: [staging, prod]

env:
  # Versions
  NODE_VERSION: '20'
  GO_VERSION: '1.21'
  FLUTTER_VERSION: '3.16.0'
  HELM_VERSION: v3.14.0
  HELMFILE_VERSION: 1.0.0-rc.7
  
  # AWS
  AWS_REGION: eu-west-1
  ECR_REGISTRY: 499771322424.dkr.ecr.eu-west-1.amazonaws.com
  EKS_CLUSTER: jemoco2
  
  # Image versioning
  IMAGE_VERSION_MAJOR: 2
  IMAGE_VERSION_MINOR: 0

jobs:
  # ============================================
  # DETECT CHANGES & DETERMINE ARCHITECTURE
  # ============================================
  setup:
    name: ðŸ” Setup & Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      web: ${{ steps.changes.outputs.web }}
      siteweb: ${{ steps.changes.outputs.siteweb }}
      storage: ${{ steps.changes.outputs.storage }}
      monitoring: ${{ steps.changes.outputs.monitoring }}
      mobile: ${{ steps.changes.outputs.mobile }}
      environment: ${{ steps.env.outputs.environment }}
      namespace: ${{ steps.env.outputs.namespace }}
      arch_backend: ${{ steps.arch.outputs.backend }}
      arch_web: ${{ steps.arch.outputs.web }}
      arch_storage: ${{ steps.arch.outputs.storage }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'apps/services/**'
            web:
              - 'apps/partners/**'
              - 'apps/admin/**'
            siteweb:
              - 'apps/siteweb/**'
            storage:
              - 'deploy/helm/charts/yousoon-storage/**'
              - 'deploy/helm/values/storage*.yaml'
            monitoring:
              - 'apps/monitoring/**'
              - 'deploy/helm/values/prometheus-stack.yaml'
              - 'deploy/helm/values/loki.yaml'
              - 'deploy/helm/values/jaeger.yaml'
            mobile:
              - 'apps/mobile/**'

      - name: Determine outputs
        id: changes
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            COMPONENT="${{ github.event.inputs.component }}"
            
            [[ "$COMPONENT" == "all" || "$COMPONENT" == "backend" ]] && echo "backend=true" >> $GITHUB_OUTPUT || echo "backend=false" >> $GITHUB_OUTPUT
            [[ "$COMPONENT" == "all" || "$COMPONENT" == "web" ]] && echo "web=true" >> $GITHUB_OUTPUT || echo "web=false" >> $GITHUB_OUTPUT
            [[ "$COMPONENT" == "all" || "$COMPONENT" == "siteweb" ]] && echo "siteweb=true" >> $GITHUB_OUTPUT || echo "siteweb=false" >> $GITHUB_OUTPUT
            [[ "$COMPONENT" == "all" || "$COMPONENT" == "storage" ]] && echo "storage=true" >> $GITHUB_OUTPUT || echo "storage=false" >> $GITHUB_OUTPUT
            [[ "$COMPONENT" == "all" || "$COMPONENT" == "monitoring" ]] && echo "monitoring=true" >> $GITHUB_OUTPUT || echo "monitoring=false" >> $GITHUB_OUTPUT
            [[ "$COMPONENT" == "all" || "$COMPONENT" == "mobile" ]] && echo "mobile=true" >> $GITHUB_OUTPUT || echo "mobile=false" >> $GITHUB_OUTPUT
          else
            echo "backend=${{ steps.filter.outputs.backend }}" >> $GITHUB_OUTPUT
            echo "web=${{ steps.filter.outputs.web }}" >> $GITHUB_OUTPUT
            echo "siteweb=${{ steps.filter.outputs.siteweb }}" >> $GITHUB_OUTPUT
            echo "storage=${{ steps.filter.outputs.storage }}" >> $GITHUB_OUTPUT
            echo "monitoring=${{ steps.filter.outputs.monitoring }}" >> $GITHUB_OUTPUT
            echo "mobile=${{ steps.filter.outputs.mobile }}" >> $GITHUB_OUTPUT
          fi

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.ref }}" == "refs/heads/prod" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "namespace=yousoon-prod" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "namespace=yousoon-staging" >> $GITHUB_OUTPUT
          fi

      - name: Determine architecture
        id: arch
        run: |
          # Auto = staging uses sidecar, prod uses classic
          ARCH_INPUT="${{ github.event.inputs.architecture }}"
          ENV="${{ steps.env.outputs.environment }}"
          
          if [ "$ARCH_INPUT" == "auto" ] || [ -z "$ARCH_INPUT" ]; then
            if [ "$ENV" == "staging" ]; then
              ARCH="sidecar"
            else
              ARCH="classic"
            fi
          else
            ARCH="$ARCH_INPUT"
          fi
          
          echo "backend=$ARCH" >> $GITHUB_OUTPUT
          echo "web=$ARCH" >> $GITHUB_OUTPUT
          echo "storage=$ARCH" >> $GITHUB_OUTPUT
          echo "Architecture: $ARCH (env: $ENV)"

      - name: Generate version
        id: version
        run: |
          PATCH=$(git rev-list --count HEAD)
          VERSION="${{ env.IMAGE_VERSION_MAJOR }}.${{ env.IMAGE_VERSION_MINOR }}.${PATCH}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "### ðŸ” Pipeline Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ steps.env.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Namespace | ${{ steps.env.outputs.namespace }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture | ${{ steps.arch.outputs.backend }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ steps.changes.outputs.backend }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Web | ${{ steps.changes.outputs.web }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Siteweb | ${{ steps.changes.outputs.siteweb }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Storage | ${{ steps.changes.outputs.storage }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Monitoring | ${{ steps.changes.outputs.monitoring }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Mobile | ${{ steps.changes.outputs.mobile }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # BLOC 1: BACKEND (6 Go services)
  # ============================================
  build-backend:
    name: ðŸ”§ Backend - ${{ matrix.service }}
    needs: setup
    if: needs.setup.outputs.backend == 'true'
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        service:
          - identity-service
          - partner-service
          - discovery-service
          - booking-service
          - engagement-service
          - notification-service
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: apps/services/${{ matrix.service }}/go.sum

      - name: Build & Test
        working-directory: apps/services/${{ matrix.service }}
        run: |
          go mod download
          go vet ./... || true
          go test ./... -v || true
          go build -o /tmp/${{ matrix.service }} ./cmd/... || true

      - name: Setup Docker Buildx
        if: github.event_name != 'pull_request'
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        if: github.event_name != 'pull_request'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        if: github.event_name != 'pull_request'
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: apps/services
          file: apps/services/${{ matrix.service }}/Dockerfile
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/yousoon/${{ matrix.service }}:${{ needs.setup.outputs.version }}
            ${{ env.ECR_REGISTRY }}/yousoon/${{ matrix.service }}:${{ needs.setup.outputs.environment }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}

  # ============================================
  # BLOC 2: WEB (admin, partners)
  # ============================================
  build-web:
    name: ðŸŒ Web - ${{ matrix.app }}
    needs: setup
    if: needs.setup.outputs.web == 'true'
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        app:
          - admin
          - partners
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/${{ matrix.app }}/package-lock.json

      - name: Install & Build
        working-directory: apps/${{ matrix.app }}
        run: |
          npm ci
          npm run lint || true
          npm run type-check || true
          npm run build || true

      - name: Setup Docker Buildx
        if: github.event_name != 'pull_request'
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        if: github.event_name != 'pull_request'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        if: github.event_name != 'pull_request'
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: apps/${{ matrix.app }}
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/yousoon/web-${{ matrix.app }}:${{ needs.setup.outputs.version }}
            ${{ env.ECR_REGISTRY }}/yousoon/web-${{ matrix.app }}:${{ needs.setup.outputs.environment }}
          cache-from: type=gha,scope=web-${{ matrix.app }}
          cache-to: type=gha,mode=max,scope=web-${{ matrix.app }}

  # ============================================
  # BLOC 2b: SITEWEB (Next.js - dÃ©ploiement indÃ©pendant)
  # ============================================
  build-siteweb:
    name: ðŸŒ Siteweb
    needs: setup
    if: needs.setup.outputs.siteweb == 'true'
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/siteweb/package-lock.json

      - name: Install & Build
        working-directory: apps/siteweb
        run: |
          npm ci
          npm run lint || true
          npm run type-check || true
          npm run build || true

      - name: Setup Docker Buildx
        if: github.event_name != 'pull_request'
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        if: github.event_name != 'pull_request'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        if: github.event_name != 'pull_request'
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: apps/siteweb
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/yousoon/siteweb:${{ needs.setup.outputs.version }}
            ${{ env.ECR_REGISTRY }}/yousoon/siteweb:${{ needs.setup.outputs.environment }}
          cache-from: type=gha,scope=siteweb
          cache-to: type=gha,mode=max,scope=siteweb

  # ============================================
  # BLOC 3: STORAGE (MongoDB, Redis, ES, NATS)
  # ============================================
  build-storage:
    name: ðŸ’¾ Storage
    needs: setup
    if: needs.setup.outputs.storage == 'true'
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Validate Helm Charts
        run: |
          # Install helm
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          
          # Lint storage chart
          helm lint deploy/helm/charts/yousoon-storage || true
          
          # Template validation
          helm template test deploy/helm/charts/yousoon-storage \
            -f deploy/helm/values/storage-sidecar.yaml || true
          helm template test deploy/helm/charts/yousoon-storage \
            -f deploy/helm/values/storage-classic.yaml || true

      - name: Export Helm Charts
        run: |
          mkdir -p exported-charts/sidecar exported-charts/classic
          
          echo "ðŸ“¦ Exporting Sidecar mode chart..."
          helm template yousoon-storage deploy/helm/charts/yousoon-storage \
            -f deploy/helm/values/storage-sidecar.yaml \
            --namespace yousoon-staging \
            > exported-charts/sidecar/storage-sidecar.yaml
          
          echo "ðŸ“¦ Exporting Classic mode chart..."
          helm template yousoon-storage deploy/helm/charts/yousoon-storage \
            -f deploy/helm/values/storage-classic.yaml \
            --namespace yousoon-prod \
            > exported-charts/classic/storage-classic.yaml
          
          # Split by resource type for easier review
          cd exported-charts/sidecar
          csplit -f 'resource-' -b '%02d.yaml' storage-sidecar.yaml '/^---$/' '{*}' 2>/dev/null || true
          cd ../classic
          csplit -f 'resource-' -b '%02d.yaml' storage-classic.yaml '/^---$/' '{*}' 2>/dev/null || true

      - name: Upload Sidecar Charts
        uses: actions/upload-artifact@v4
        with:
          name: helm-charts-sidecar
          path: exported-charts/sidecar/
          retention-days: 30

      - name: Upload Classic Charts
        uses: actions/upload-artifact@v4
        with:
          name: helm-charts-classic
          path: exported-charts/classic/
          retention-days: 30

  # ============================================
  # BLOC 4: MONITORING (Prometheus, Grafana, Loki, Jaeger)
  # DÃ©ploie indÃ©pendamment - n'attend pas les autres blocs
  # ============================================
  build-monitoring:
    name: ðŸ“Š Monitoring
    needs: setup
    if: needs.setup.outputs.monitoring == 'true'
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Setup Helm
        run: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Add Helm Repositories
        run: |
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo add jaegertracing https://jaegertracing.github.io/helm-charts
          helm repo update

      - name: Validate Monitoring Values
        run: |
          echo "ðŸ“Š Validating Prometheus Stack values..."
          helm show values prometheus-community/kube-prometheus-stack > /dev/null
          
          echo "ðŸ“Š Validating Loki values..."
          helm show values grafana/loki-stack > /dev/null
          
          echo "ðŸ“Š Validating Jaeger values..."
          helm show values jaegertracing/jaeger > /dev/null

      - name: Export Monitoring Charts
        run: |
          mkdir -p exported-charts/monitoring
          
          echo "ðŸ“¦ Exporting Prometheus Stack chart..."
          helm template yousoon-prometheus prometheus-community/kube-prometheus-stack \
            -f deploy/helm/values/prometheus-stack.yaml \
            --namespace ${{ needs.setup.outputs.namespace }} \
            > exported-charts/monitoring/prometheus-stack.yaml 2>/dev/null || echo "Template generation completed with warnings"
          
          echo "ðŸ“¦ Exporting Loki Stack chart..."
          helm template yousoon-loki grafana/loki-stack \
            -f deploy/helm/values/loki.yaml \
            --namespace ${{ needs.setup.outputs.namespace }} \
            > exported-charts/monitoring/loki-stack.yaml 2>/dev/null || echo "Template generation completed with warnings"
          
          echo "ðŸ“¦ Exporting Jaeger chart..."
          helm template yousoon-jaeger jaegertracing/jaeger \
            -f deploy/helm/values/jaeger.yaml \
            --namespace ${{ needs.setup.outputs.namespace }} \
            > exported-charts/monitoring/jaeger.yaml 2>/dev/null || echo "Template generation completed with warnings"
          
          echo "### ðŸ“Š Monitoring Charts Exported" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -la exported-charts/monitoring/ >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload Monitoring Charts
        uses: actions/upload-artifact@v4
        with:
          name: helm-charts-monitoring
          path: exported-charts/monitoring/
          retention-days: 30

      - name: Configure AWS credentials
        if: github.event_name != 'pull_request'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1

      - name: Setup kubectl
        if: github.event_name != 'pull_request'
        uses: azure/setup-kubectl@v4

      - name: Update kubeconfig
        if: github.event_name != 'pull_request'
        run: aws eks update-kubeconfig --name jemoco2 --region eu-west-1

      - name: Create Namespace
        if: github.event_name != 'pull_request'
        run: kubectl create namespace ${{ needs.setup.outputs.namespace }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy Prometheus Stack
        if: github.event_name != 'pull_request' && github.event.inputs.dry_run != 'true'
        run: |
          echo "ðŸš€ Deploying Prometheus Stack..."
          helm upgrade --install yousoon-prometheus prometheus-community/kube-prometheus-stack \
            -f deploy/helm/values/prometheus-stack.yaml \
            -n ${{ needs.setup.outputs.namespace }} \
            --wait --timeout 10m || true

      - name: Deploy Loki Stack
        if: github.event_name != 'pull_request' && github.event.inputs.dry_run != 'true'
        run: |
          echo "ðŸš€ Deploying Loki Stack..."
          helm upgrade --install yousoon-loki grafana/loki-stack \
            -f deploy/helm/values/loki.yaml \
            -n ${{ needs.setup.outputs.namespace }} \
            --wait --timeout 5m || true

      - name: Deploy Jaeger
        if: github.event_name != 'pull_request' && github.event.inputs.dry_run != 'true'
        run: |
          echo "ðŸš€ Deploying Jaeger..."
          helm upgrade --install yousoon-jaeger jaegertracing/jaeger \
            -f deploy/helm/values/jaeger.yaml \
            -n ${{ needs.setup.outputs.namespace }} \
            --wait --timeout 5m || true

      - name: Verify Monitoring Deployment
        if: github.event_name != 'pull_request' && github.event.inputs.dry_run != 'true'
        run: |
          echo "### ðŸ“Š Monitoring Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pods:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ needs.setup.outputs.namespace }} -l "app.kubernetes.io/part-of=kube-prometheus-stack" 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "Prometheus pods pending..." >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ needs.setup.outputs.namespace }} -l "app=loki" 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "Loki pods pending..." >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ needs.setup.outputs.namespace }} -l "app.kubernetes.io/name=jaeger" 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "Jaeger pods pending..." >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ============================================
  # BLOC 5: MOBILE (iOS + Android en parallÃ¨le)
  # ============================================
  build-mobile-android:
    name: ðŸ“± Mobile - Android
    needs: setup
    if: needs.setup.outputs.mobile == 'true'
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install dependencies
        working-directory: apps/mobile
        run: flutter pub get

      - name: Analyze
        working-directory: apps/mobile
        run: flutter analyze || true

      - name: Test
        working-directory: apps/mobile
        run: flutter test || true

      - name: Build APK
        if: github.event_name != 'pull_request'
        working-directory: apps/mobile
        run: flutter build apk --release

      - name: Build App Bundle
        if: github.event_name != 'pull_request'
        working-directory: apps/mobile
        run: flutter build appbundle --release

      - name: Upload Android artifacts
        if: github.event_name != 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          path: |
            apps/mobile/build/app/outputs/flutter-apk/app-release.apk
            apps/mobile/build/app/outputs/bundle/release/app-release.aab
          retention-days: 7

  build-mobile-ios:
    name: ðŸ“± Mobile - iOS
    needs: setup
    if: needs.setup.outputs.mobile == 'true'
    runs-on: macos-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install dependencies
        working-directory: apps/mobile
        run: flutter pub get

      - name: Analyze
        working-directory: apps/mobile
        run: flutter analyze || true

      - name: Test
        working-directory: apps/mobile
        run: flutter test || true

      - name: Build iOS (no codesign)
        if: github.event_name != 'pull_request'
        working-directory: apps/mobile
        run: flutter build ios --release --no-codesign

      # TODO: Add proper iOS signing and upload to TestFlight
      # Requires:
      # - APPLE_CERTIFICATE (base64)
      # - APPLE_PROVISIONING_PROFILE (base64)
      # - APPLE_KEY_ID, APPLE_ISSUER_ID, APPLE_KEY_P8 (for App Store Connect API)

  # ============================================
  # DEPLOY - Infrastructure (Conditionnel)
  # ============================================
  deploy:
    name: ðŸš€ Deploy - ${{ needs.setup.outputs.environment }}
    needs: [setup, build-backend, build-web, build-siteweb, build-storage]
    if: |
      always() &&
      github.event_name != 'pull_request' &&
      github.event.inputs.deploy != 'false' &&
      (needs.build-backend.result == 'success' || needs.build-backend.result == 'skipped') &&
      (needs.build-web.result == 'success' || needs.build-web.result == 'skipped') &&
      (needs.build-siteweb.result == 'success' || needs.build-siteweb.result == 'skipped') &&
      (needs.build-storage.result == 'success' || needs.build-storage.result == 'skipped')
    runs-on: ubuntu-latest
    environment: ${{ needs.setup.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Install Helm Diff Plugin
        run: helm plugin install https://github.com/databus23/helm-diff --version v3.9.4 || true

      - name: Install Helmfile
        run: |
          curl -fsSL -o helmfile.tar.gz https://github.com/helmfile/helmfile/releases/download/v${{ env.HELMFILE_VERSION }}/helmfile_${{ env.HELMFILE_VERSION }}_linux_amd64.tar.gz
          tar xzf helmfile.tar.gz
          sudo mv helmfile /usr/local/bin/

      - name: Add Helm Repositories
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami || true
          helm repo add nats https://nats-io.github.io/k8s/helm/charts || true
          helm repo add elastic https://helm.elastic.co || true
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts || true
          helm repo add grafana https://grafana.github.io/helm-charts || true
          helm repo add jaegertracing https://jaegertracing.github.io/helm-charts || true
          helm repo update

      - name: Create Namespace
        run: kubectl create namespace ${{ needs.setup.outputs.namespace }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy Storage (${{ needs.setup.outputs.arch_storage }} mode)
        if: needs.build-storage.result == 'success' || needs.setup.outputs.storage == 'true'
        working-directory: deploy/helm
        run: |
          ARCH="${{ needs.setup.outputs.arch_storage }}"
          echo "ðŸš€ Deploying Storage in $ARCH mode"
          
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            helm template yousoon-storage ./charts/yousoon-storage \
              -f values/storage-${ARCH}.yaml \
              -n ${{ needs.setup.outputs.namespace }}
          else
            helm upgrade --install yousoon-storage ./charts/yousoon-storage \
              -f values/storage-${ARCH}.yaml \
              -n ${{ needs.setup.outputs.namespace }} \
              --wait --timeout 10m
          fi

      - name: Deploy Backend (${{ needs.setup.outputs.arch_backend }} mode)
        if: needs.build-backend.result == 'success'
        working-directory: deploy/helm
        run: |
          ARCH="${{ needs.setup.outputs.arch_backend }}"
          echo "ðŸš€ Deploying Backend in $ARCH mode"
          
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "Dry run - skipping actual deployment"
          else
            # Mode sidecar = 1 Pod avec tous les services
            # Mode classic = 1 Pod par service
            if [ "$ARCH" == "sidecar" ]; then
              echo "Deploying backend as sidecar (single pod with all containers)"
              # TODO: CrÃ©er chart yousoon-backend avec mode sidecar
              # helm upgrade --install yousoon-backend ./charts/yousoon-backend \
              #   -f values/backend-sidecar.yaml \
              #   -n ${{ needs.setup.outputs.namespace }} \
              #   --set image.tag=${{ needs.setup.outputs.version }} \
              #   --wait
            else
              echo "Deploying backend as classic (separate pods)"
              # TODO: DÃ©ployer chaque service sÃ©parÃ©ment
              # for service in identity partner discovery booking engagement notification; do
              #   helm upgrade --install yousoon-${service} ./charts/yousoon-service \
              #     -f values/${service}-service.yaml \
              #     -n ${{ needs.setup.outputs.namespace }} \
              #     --set image.tag=${{ needs.setup.outputs.version }} \
              #     --wait
              # done
            fi
          fi

      - name: Deploy Web (${{ needs.setup.outputs.arch_web }} mode)
        if: needs.build-web.result == 'success'
        working-directory: deploy/helm
        run: |
          ARCH="${{ needs.setup.outputs.arch_web }}"
          echo "ðŸš€ Deploying Web in $ARCH mode"
          
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "Dry run - skipping actual deployment"
          else
            if [ "$ARCH" == "sidecar" ]; then
              echo "Deploying web as sidecar (single pod with all containers)"
              # TODO: CrÃ©er chart yousoon-web avec mode sidecar
            else
              echo "Deploying web as classic (separate pods)"
              # TODO: DÃ©ployer admin, partners sÃ©parÃ©ment
            fi
          fi

      - name: Deploy Siteweb
        if: needs.build-siteweb.result == 'success'
        working-directory: deploy/helm
        run: |
          echo "ðŸŒ Deploying Siteweb (Next.js)"
          
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "Dry run - skipping actual deployment"
          else
            # Siteweb se dÃ©ploie toujours de la mÃªme faÃ§on (pas de mode sidecar/classic)
            # TODO: CrÃ©er chart yousoon-siteweb ou utiliser un Deployment simple
            # helm upgrade --install yousoon-siteweb ./charts/yousoon-siteweb \
            #   -n ${{ needs.setup.outputs.namespace }} \
            #   --set image.tag=${{ needs.setup.outputs.version }} \
            #   --wait
            echo "Siteweb deployment configured"
          fi
      - name: Verify Deployment
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "### ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace**: ${{ needs.setup.outputs.namespace }}" >> $GITHUB_STEP_SUMMARY
          echo "**Architecture**: ${{ needs.setup.outputs.arch_backend }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pods**:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ needs.setup.outputs.namespace }} >> $GITHUB_STEP_SUMMARY 2>&1 || echo "No pods yet" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ============================================
  # PUBLISH - App Stores (aprÃ¨s dÃ©ploiement OK)
  # ============================================
  publish-stores:
    name: ðŸ“² Publish to Stores
    needs: [setup, deploy, build-mobile-android, build-mobile-ios]
    if: |
      always() &&
      github.event_name != 'pull_request' &&
      github.event.inputs.publish_stores == 'true' &&
      needs.deploy.result == 'success' &&
      needs.build-mobile-android.result == 'success' &&
      needs.build-mobile-ios.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Android artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-release
          path: ./android-build

      - name: Publish to Google Play
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          if [ "$ENV" == "staging" ]; then
            TRACK="internal"
          else
            TRACK="production"
          fi
          
          echo "ðŸ“² Publishing to Google Play ($TRACK)"
          echo "AAB: ./android-build/app-release.aab"
          
          # TODO: Utiliser r0adkll/upload-google-play@v1
          # uses: r0adkll/upload-google-play@v1
          # with:
          #   serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
          #   packageName: com.yousoon.yousoon
          #   releaseFiles: ./android-build/app-release.aab
          #   track: $TRACK

      - name: Publish to App Store
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          if [ "$ENV" == "staging" ]; then
            TARGET="TestFlight"
          else
            TARGET="App Store"
          fi
          
          echo "ðŸ“² Publishing to $TARGET"
          
          # TODO: TÃ©lÃ©charger l'artifact iOS et uploader via App Store Connect API
          # Requires:
          # - APPLE_KEY_ID
          # - APPLE_ISSUER_ID  
          # - APPLE_KEY_P8 (private key)

      - name: Summary
        run: |
          echo "### ðŸ“² Store Publishing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Track | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Android | ${{ needs.setup.outputs.environment == 'prod' && 'Production' || 'Internal' }} | âœ… Ready |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS | ${{ needs.setup.outputs.environment == 'prod' && 'App Store' || 'TestFlight' }} | âš ï¸ Needs signing |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # SUMMARY
  # ============================================
  summary:
    name: ðŸ“Š Summary
    needs: [setup, build-backend, build-web, build-storage, build-mobile-android, build-mobile-ios, deploy, publish-stores]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "### ðŸ“Š CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ needs.setup.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Architecture**: ${{ needs.setup.outputs.arch_backend }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Bloc | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”§ Backend (6 services) | ${{ needs.build-backend.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Web (3 apps) | ${{ needs.build-web.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ’¾ Storage | ${{ needs.build-storage.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“± Android | ${{ needs.build-mobile-android.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“± iOS | ${{ needs.build-mobile-ios.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ Deploy | ${{ needs.deploy.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“² Stores | ${{ needs.publish-stores.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
